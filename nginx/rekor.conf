server {
    listen 80;

    # /checkpoint -> GCS tile storage
    location = /checkpoint {
        proxy_pass http://gcs:7080/tiles/checkpoint;
        proxy_set_header Host localhost:7080;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # /tile/* -> GCS tile storage
    location /tile/ {
        rewrite ^/tile/(.*)$ /tiles/tile/$1 break;
        proxy_pass http://gcs:7080;
        proxy_set_header Host localhost:7080;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # /log/entries -> rekor API (for adding entries)
    location = /log/entries {
        proxy_pass http://rekor:3000/api/v2/log/entries;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Content-Type $content_type;
    }

    # Pass through healthz from rekor
    location = /healthz {
        proxy_pass http://rekor:3000/healthz;
    }

    # Pass through original /api/v2/* paths for backwards compatibility
    location /api/v2/ {
        proxy_pass http://rekor:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Default: proxy to GCS tile storage
    location / {
        proxy_pass http://gcs:7080/tiles/;
        proxy_set_header Host localhost:7080;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
